# Скрипты для миграции инфраструктуры на SDN Sprut.

Миграция виртуальных машин между SDN, представляет собой перенос сетевого порта, к которому происходит подключение.
"Расширенная инструкция по миграции описана в файле **Полное руководство по миграции на SDN SPRUT v.1.pdf**. Для более актуальной версии можете обратиться к своему менеджеру от vk cloud.

В папке /examples есть примеры на terraform и входные файлы для теста скриптов.



## Скрипт для миграции одной виртуальной машины между SDN.

[migrator.sh](../migrator.sh)

#### Подготовительные действия.

**ВАЖНО!** Перед выполнением скрипта убедиться, что **ВМ активна**, а сеть и подсеть в SDN Sprut с повторяющейся адресацией по отношению к сети и подсети Neutron созданы.

**ВАЖНО!** Скрипт позволяет выполнить миграцию порта ВМ с сохранением MAC / IP адресов или без сохранения. Управление данным функционалом вынесено в параметр запуска скрипта.

```bash
./migrator.sh --opt <clone/noclone>
```

> где в качестве значения следует использовать одну из 2х опций:

> - clone (миграция с сохранением информации о MAC / IP адресах)
> - noclone (миграция с назначением случайных MAC / IP адресов из целевой сети / подсети)

Перед запуском скрипта фиксируем основные значения:
1. логическое имя сервера
1. сеть назначения в SDN Sprut
1. подсеть назначения в SDN Sprut

Примечание. При запуске сценария консоль будет ожидать ввода от пользователя. Заполняем "анкету" и запускаем миграцию порта.

#### Пост-миграционные шаги

ВАЖНО! На уровне ОС следует выполнить опрос DHCP сервера для получения IP адреса на вновь добалвенный сетевой интерфейс.

Для Windows:

```
ipconfig /release
ipconfig /renew
```

Для Lunix:
```bash
dhclient
```

## Скрипт для миграции нескольких виртуальных машин между SDN.

[migrator-multiple.sh](../migrator-multiple.sh)

**ВАЖНО!** У мигрируемых вм должно быть одно подключение к сети, для миграции вм с несколькими портами необходимо использовать другой скрипт.

**ВАЖНО!** Скрипт выполняет все действия (инспекция, создание, переключение портов) в рамках одной итерации. На одну вм уходит ~45 секунд.  В случае если техокно необходимо сократить, можно использовать связку из скриптов audit-create-sprut-ports.sh (создание портов) и audit-replace-neutron-to-sprut.sh (переключение). В таком случае на вм будет уходить ~15 секунд.

**Важно!** Скрипт копирует секьюрити группы с портов и вешает на новые порты, но группы должны быть заранее созданы на sprut и иметь исходное имя группы на нейтроне + постфикс -sprut. Наприме: на нейтроновском порте вести группа web, значит нужно заранее создать для спрута секьюрити группу web-sprut. Для этого можно использовать скрипт в этом репозитории copy-security-group.

**ВАЖНО!** Перед выполнением скрипта убедиться, что **ВМ активна**, а сеть и подсеть в SDN Sprut с повторяющейся адресацией по отношению к сети и подсети Neutron созданы.

Скрипт принимает на вход опцию --opt и csv файл на миграцию.

```shell
./migrator-multiple.sh <имя .csv файла>
```

формат csv файла:

```
Имя_вм_1,имя_новой_сети_на_sprut,имя_новой_подсети_на_sprut
Имя_вм_1,имя_новой_сети_на_sprut,имя_новой_подсети_на_sprut,id_плавающего_ip_sprut

```
id_плавающего_ip_sprut - опциональный параметр, позваляют сразу навесить на новый порт плавающий ip в сети sprut.

**ВАЖНО!** Разделителем в csv файле должна быть запятая

**ВАЖНО!** Файл должен заканчиваться символом newline

## Скрипт копирования security group

**copy-security-group.sh**

Позволяет скопировать security группы. Новые группы будут иметь название исходной группы + постфикс -sprut.

Параметры:

```bash
--group-mapping=<id группы на neutron 1>=<id группы на sprut 1>,<id группы на neutron 2>=<id группы на sprut 2>,...
```
В случае, если используются правила где в источниках указаны другие секьюрити группы (например default), необходимо передать такой словарь где будет id базвой группы на neutron и тот же айди на sprut. Как правило это группы: all, default, ssh+www. ID можно извлечь из графического интерфейса облака, где будет подписано к какому sdn относится группа. ID этих базовых групп для каждого проекта разные, поэтому переиспользовать для других проектов их не получится.

```bash
--groups=группа1,группа2,...
```
Список групп на нейтроне, которые надо копировать на спрут.

Пример:
```bash
./copy-security-group.sh --group-mapping=dfae29b0-e35d-4328-82fe-28944a34497b=8492ee54-a0a6-4dd1-a8af-0c73d4b5edf5,2e2e2dea-3d0e-43c4-8b46-175799099cfe=d7881417-4ac4-404c-82b6-311da32b6386,58fb65aa-d3d1-4765-b5bb-b752e70baf6b=5a60883e-c165-4f2d-9477-4c417acd5d6f \ 
--groups=test-neutron-sg 
```

Здесь передан словарь с соответствиями id групп default, all, ssh+www. 

## Проверка наличия секьюрити групп на спруте, аналогичных нейтроновским

**check-if-all-sprut-sg-present.sh**

Скрипт проверяет группы на каждой вм и далее проверяет наличие групп с таким же названием и постфиксом -sprut.
Группы default, all, ssh+www игнорируются, так как являются базовыми для нейторна и спрута.

```bash
./check-if-all-sprut-sg-present.sh
```

```shell
------------------------------------
Security Group Check Summary
------------------------------------
The following security groups do not have corresponding '-sprut' groups:
- cluster_ml_sec_group
- custom-sprut-postgre
- icmp
------------------------------------
```

## Скрипт обновления состояния терраформа после миграции

**modify_terraform_state.sh**

В случае, если используется terraform в качестве основного инструмента управления инфраструктурой, необходимо описать копии сетей, групп безопасности, роутеров и других компонентов на sdn sprut, для этого необходимо проставить соответствующие параметры. Например есть исходная сеть на нейтроне: 

```c
resource "vkcs_networking_network" "app" {
  name        = "app-tf-example"
  description = "Application network"
}
```

Мы создаём копию на спруте, при этом для чёткого разграничения указываем у исходной сети на нейтроне sdn=neutron.

```c
resource "vkcs_networking_network" "app" {
  name        = "app-tf-example"
  description = "Application network"
  sdn = "neutron"
}

resource "vkcs_networking_network" "app-sprut" {
  name        = "app-tf-example-sprut"
  description = "Application network"
  sdn = "sprut"
}
```

Мигрируем скриптом вм, после чего правим в манифесте вм сеть, к которой подключена вм (уже на спрут).

**ВАЖНО!** Перед правкой файлов терраформа рекомендуется сделать резервную копию.

Запускаем скрипт изменения состояния ./modify_terraform_state.sh

Получаем скрипт terraform_modify_to_sprut_state.sh и таблицу state_modification_table.txt с именами вм в терраформе и их id в openstack.

Скрипт **terraform_modify_to_sprut_state.sh** состоит из команд изменения состояний для каждой вм:

```bash
terraform state rm
terraform import
```

При каждом выполнении шага в скрипте создаётся новая версия-копия стейт файла терраформа для отката в случае проблем. 

**ВАЖНО!** Рекомендуется перед запуском скрипта изменения стейта сделать исходную копию исходной стейт файла терраформа.
